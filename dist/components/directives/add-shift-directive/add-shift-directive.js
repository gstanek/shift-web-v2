angular.module("ShiftOnTapApp").directive("addShiftDirective",["realmService","userService","shiftService","commonService",function(a,b,c,d){"ngInject";return{restrict:"E",scope:{save:"&onSave",cancel:"&onCancel",errorObj:"="},templateUrl:"components/directives/add-shift-directive/add-shift.html",link:function(d,e,f,g){d.isActiveRealm=a.isActiveRealm(),d.user=b.getLocalUser();var h=function(){if(d.user){var a=c.getLocalShifts();return!!a}return!1};d.isShiftPresent=function(){return h()},d.companyName=a.getRealmName(),d.newShiftModel={id:"",dateRangeStart:"",dateRangeEnd:"",comment:"",first_name:d.user.first_name,last_name:d.user.last_name},d.createShift=function(a){if(a.$valid){d.newShiftModel.first_name==d.user.first_name&&d.newShiftModel.lastName==d.user.last_name||(d.newShiftModel.first_name&&(d.user.first_name=d.newShiftModel.first_name),d.newShiftModel.last_name&&(d.user.last_name=d.newShiftModel.last_name),b.updateUser(d.user).then(function(a){b.setLocalUser(a)},function(a){}));var e={startDate:d.shiftDetails.startDate,startTime:d.shiftDetails.startTime,endDate:d.shiftDetails.endDate,endTime:d.shiftDetails.endTime,comment:d.newShiftModel.comment};c.storeShift(e).then(function(a){c.setLocalShift(a.data,!0),d.save()},function(a){})}else angular.forEach(a.$error,function(a){angular.forEach(a,function(a){a.$setTouched()})}),d.errorObj.detail="Please correct errors indicated above and resubmit"},d.format="shortDate",d.popup1={opened:!1},d.popup2={opened:!1};var i=function(a){var b=Math.floor(a.minutes()/15);return a.minutes()%15!=0&&b++,4==b&&(a.add(1,"hours"),b=0),a.minutes(15*b),a.seconds(0),a},j=moment(),k=i(j);d.shiftDetails={startDate:j,startTime:i(moment(j)).toDate(),endDate:j.toDate(),endTime:k.add(15,"minute").toDate(),comment:""};var l=moment().tz(d.user.timezone).add(5,"years");d.startDateOptions={formatYear:"yy",maxDate:l.toDate(),minDate:moment().tz(d.user.timezone).toDate(),startingDay:0},d.endDateOptions={formatYear:"yy",maxDate:l.toDate(),minDate:d.shiftDetails.startDate,startingDay:0};var m=function(){return 0==moment().diff(moment(d.shiftDetails.startDate),"days")?moment(d.shiftDetails.startTime).tz(d.user.timezone).toDate():moment().startOf("Day").toDate()};console.log("min start time="+m()),d.endTimeOptions={formatYear:"yy",maxDate:l.toDate(),minDate:moment(d.shiftDetails.startTime).add(15,"minutes").tz(d.user.timezone).toDate(),startingDay:0},d.startTimeOptions={formatYear:"yy",maxDate:l.toDate(),minDate:m(),startingDay:0},d.today=function(){return moment().toDate()},d.startDateToday=function(){d.shiftDetails.startDate=d.today()},d.startDateToday(),d.endDateToday=function(){d.shiftDetails.endDate=d.today()},d.endDateToday(),d.startDateClear=function(){d.shiftDetails.startDate=null},d.endDateClear=function(){d.shiftDetails.endDate=null},d.open1=function(){d.popup1.opened=!0},d.open2=function(){d.popup2.opened=!0},d.$watch("shiftDetails.startDate",function(a){d.endDateOptions.minDate=d.shiftDetails.startDate,moment(d.shiftDetails.endDate).isBefore(moment(d.shiftDetails.startDate))&&(d.shiftDetails.endDate=d.shiftDetails.startDate)}),d.$watch("shiftDetails.startTime",function(a){moment(d.shiftDetails.endDate).isSame(d.shiftDetails.startDate,"day")&&(d.endTimeOptions.minDate=moment(d.shiftDetails.startTime).add(15,"minutes").toDate(),moment(d.shiftDetails.endTime).isSameOrBefore(d.shiftDetails.startTime,"minute")&&(d.shiftDetails.endTime=moment(d.shiftDetails.startTime).add(15,"minutes").toDate()))}),d.showEndDateEntry=!1,d.startDateHeader="Shift Date",d.endDateHeader="Shift End Date",d.toggleShowEndDate=function(){if(d.showEndDateEntry=!d.showEndDateEntry,d.showEndDateEntry){d.startDateHeader="Shift Start Date";var a=new Date;a.setHours(0),a.setMinutes(0),a.setMilliseconds(0),d.endTimeOptions.minDate=a;var b=new Date;b.setDate(b.getDate()+1),d.shiftDetails.endDate=b}else d.startDateHeader="Shift Date",moment(d.shiftDetails.startTime).add(15,"minutes").isAfter(d.shiftDetails.endTime)&&(d.shiftDetails.endTime=moment(d.shiftDetails.startTime).add(15,"minutes").toDate()),d.endTimeOptions.minDate=moment(d.shiftDetails.startTime).add(15,"minutes").toDate(),d.shiftDetails.endDate=d.shiftDetails.startDate},d.startTimeHeader="Shift Start Time",d.endTimeHeader="Shift End Time"}}}]);